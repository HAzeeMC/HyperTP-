name: Java CI with Maven

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    name: Build HyperTP
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build with Maven
      run: |
        echo "ðŸ—ï¸ Building HyperTP plugin..."
        mvn -B clean compile
        echo "âœ… Compilation successful"

    - name: Run unit tests
      run: |
        echo "ðŸ§ª Running tests..."
        mvn -B test
        echo "âœ… Tests completed"

    - name: Package JAR
      run: |
        echo "ðŸ“¦ Packaging JAR file..."
        mvn -B package -DskipTests
        echo "âœ… Packaging completed"

    - name: Verify JAR
      run: |
        echo "ðŸ” Verifying JAR structure..."
        JAR_FILE=$(find target -name "HyperTP-*.jar" | head -1)
        
        if [ -z "$JAR_FILE" ]; then
          echo "âŒ No JAR file found!"
          exit 1
        fi
        
        echo "ðŸ“ JAR File: $JAR_FILE"
        
        # Check JAR validity
        jar -tf "$JAR_FILE" > /dev/null
        echo "âœ… JAR structure is valid"
        
        # Check file size
        FILE_SIZE=$(stat -c%s "$JAR_FILE")
        echo "ðŸ“Š File Size: $((FILE_SIZE / 1024)) KB"
        
        # Check essential files
        echo "ðŸ“‹ Essential files check:"
        if jar -tf "$JAR_FILE" | grep -q "plugin.yml"; then
          echo "âœ… plugin.yml found"
        else
          echo "âŒ plugin.yml missing"
          exit 1
        fi
        
        if jar -tf "$JAR_FILE" | grep -q "com/hazee/hypertp/HyperTP.class"; then
          echo "âœ… Main class found"
        else
          echo "âŒ Main class missing"
          exit 1
        fi

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: HyperTP-Plugin
        path: target/HyperTP-*.jar
        retention-days: 30

    - name: Build Summary
      run: |
        echo "ðŸŽ‰ HyperTP Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "============================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: 1.1.0" >> $GITHUB_STEP_SUMMARY
        echo "**Java Version**: 21" >> $GITHUB_STEP_SUMMARY  
        echo "**Minecraft**: 1.21-1.21.8" >> $GITHUB_STEP_SUMMARY
        echo "**Build Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
        echo "Download the JAR file from the **Artifacts** section above." >> $GITHUB_STEP_SUMMARY
