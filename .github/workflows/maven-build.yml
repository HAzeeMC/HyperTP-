name: Java CI with Maven

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build with Maven
      run: mvn -B clean package --file pom.xml

    - name: Run tests
      run: mvn -B test --file pom.xml

    - name: Verify JAR structure
      run: |
        echo "ðŸ” Verifying JAR file structure..."
        JAR_FILE=$(ls target/HyperTP-*.jar)
        
        # Check if JAR is valid
        jar -tf "$JAR_FILE" > /dev/null
        echo "âœ… JAR file structure is valid"
        
        # Check file size
        FILE_SIZE=$(stat -c%s "$JAR_FILE")
        echo "ðŸ“Š JAR Size: $((FILE_SIZE / 1024)) KB"
        
        # Check essential files in JAR
        jar -tf "$JAR_FILE" | grep -E "(plugin.yml|com/hazee/hypertp/HyperTP.class)" || echo "âŒ Essential files missing"

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: HyperTP-Plugin
        path: target/HyperTP-*.jar
        retention-days: 30

    - name: Build Report
      run: |
        echo "ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Build Status**: SUCCESS" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ·ï¸ **Version**: 1.1.0" >> $GITHUB_STEP_SUMMARY
        echo "â˜• **Java Version**: 21" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Minecraft**: 1.21-1.21.8" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“… **Build Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ Download" >> $GITHUB_STEP_SUMMARY
        echo "Download the JAR file from the **Artifacts** section above." >> $GITHUB_STEP_SUMMARY
