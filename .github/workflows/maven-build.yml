name: Build HyperTP Plugin

on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build with Maven
      run: |
        echo "ðŸ—ï¸ Building HyperTP..."
        mvn -B clean compile
        echo "âœ… Compilation successful"

    - name: Run tests
      run: |
        echo "ðŸ§ª Running tests..."
        mvn -B test
        echo "âœ… Tests completed"

    - name: Create JAR package
      run: |
        echo "ðŸ“¦ Creating JAR file..."
        mvn -B package -DskipTests
        
        # Display JAR info
        JAR_FILE=$(ls target/HyperTP-*.jar)
        echo "ðŸŽ¯ JAR Created: $JAR_FILE"
        ls -la target/*.jar
        
        # Show file size
        FILE_SIZE=$(stat -c%s "$JAR_FILE")
        echo "ðŸ“Š JAR Size: $((FILE_SIZE / 1024)) KB"

    - name: Verify JAR contents
      run: |
        echo "ðŸ” Verifying JAR structure..."
        JAR_FILE=$(ls target/HyperTP-*.jar)
        
        # Test JAR validity
        jar -tf "$JAR_FILE" > /dev/null
        echo "âœ… JAR is valid"
        
        # Show important files
        echo "ðŸ“ Important files in JAR:"
        jar -tf "$JAR_FILE" | grep -E "(plugin.yml|com/hazee/hypertp/HyperTP.class)" | head -10
        
        # Extract plugin.yml to verify
        jar -xf "$JAR_FILE" plugin.yml
        if [ -f "plugin.yml" ]; then
          echo "ðŸ“„ Plugin Info:"
          cat plugin.yml
          rm plugin.yml
        fi

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: HyperTP-Plugin-JAR
        path: target/HyperTP-*.jar
        retention-days: 30
        overwrite: true

    - name: Create build info file
      run: |
        echo "ðŸ“ Creating build info..."
        cat > build-info.txt << EOF
HyperTP Build Information
========================
Version: 1.1.0
Build Date: $(date -u)
Java Version: 21
Minecraft: 1.21-1.21.8
Git Commit: ${{ github.sha }}
Build Runner: ${{ runner.os }}

Features:
- Home System with GUI
- TPA Request System
- Random Teleport (RTP)
- Back to Previous Location
- Multi-language Support
- Folia & Paper Support

Installation:
1. Download the JAR file
2. Place in plugins/ folder
3. Restart server
4. Configure in plugins/HyperTP/config.yml

Author: H_Azee
EOF

    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: Build-Information
        path: build-info.txt
        retention-days: 30

    - name: Build Summary
      run: |
        echo "ðŸŽ‰ HyperTP Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "============================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Build Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: 1.1.0" >> $GITHUB_STEP_SUMMARY
        echo "- **Java**: 21" >> $GITHUB_STEP_SUMMARY
        echo "- **Minecraft**: 1.21-1.21.8" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Output Files" >> $GITHUB_STEP_SUMMARY
        echo "1. **HyperTP-Plugin-JAR** - The plugin JAR file" >> $GITHUB_STEP_SUMMARY
        echo "2. **Build-Information** - Build details and instructions" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸš€ Quick Start" >> $GITHUB_STEP_SUMMARY
        echo "1. Download **HyperTP-Plugin-JAR** from Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "2. Place in your server's \`plugins/\` folder" >> $GITHUB_STEP_SUMMARY
        echo "3. Restart the server" >> $GITHUB_STEP_SUMMARY
        echo "4. Use \`/htp help\` for commands" >> $GITHUB_STEP_SUMMARY
